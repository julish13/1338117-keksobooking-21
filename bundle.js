(()=>{"use strict";(()=>{const e=document.querySelector("#error").content,t=document.querySelector(".ad-form"),o=(o,n)=>{const r=document.createDocumentFragment(),i=(t=>{const o=e.querySelector(".error").cloneNode(!0);return o.querySelector(".error__message").textContent=t,o})(o);r.appendChild(i);const a=i.querySelector(".error__button"),c=()=>{window.upload.clearAvatarPreview(),window.upload.clearHousingPictures(),i.remove(),t.reset(),a.removeEventListener("click",c),document.removeEventListener("keydown",d),n&&document.removeEventListener("click",c)},d=e=>{"Escape"===e.key&&(e.preventDefault(),c())};a.addEventListener("click",c),document.addEventListener("keydown",d),n&&document.addEventListener("click",c),document.querySelector("main").insertAdjacentElement("afterbegin",i)},n=(e,t,o)=>{e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o(`Статус ответа: ${e.status} ${e.statusText}`)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4},r=(e,t,o)=>{const r=new XMLHttpRequest;n(r,t,o),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(e)};window.backend={load:(e,t)=>{const o=new XMLHttpRequest;n(o,e,t),o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},save:r,onLoadError:e=>{o(e)},onSubmitError:e=>{o(e,r)},adverts:[],filteredAdverts:[]}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=t.offsetWidth,n=t.offsetHeight;window.renderPinsArray=r=>{const i=document.createDocumentFragment();r.forEach((e=>{i.appendChild((e=>{const r=t.cloneNode(!0),i=r.querySelector("img");return r.style=`left: ${e.location.x-o/2}px; top: ${e.location.y-n}px`,i.src=e.author.avatar,i.alt=e.offer.title,r})(e))})),e.appendChild(i)}})(),(()=>{const e=document.querySelector(".map").offsetWidth,t=document.querySelector(".map__pin--main"),o=t.offsetHeight+26,n=t.offsetWidth,r=document.querySelector(".ad-form").querySelector("input[name=address]");window.onMovePin=i=>{let a={x:i.clientX,y:i.clientY};const c=i=>{const c=a.x-i.clientX,d=a.y-i.clientY;a={x:i.clientX,y:i.clientY},t.offsetTop<=130-o?t.style.top=130-o-d+"px":t.offsetTop>=630-o?t.style.top=630-o-d+"px":t.style.top=t.offsetTop-d+"px",t.offsetLeft<=-n/2?t.style.left=-n/2-c+"px":t.offsetLeft>=e-n/2?t.style.left=e-n/2-c+"px":t.style.left=t.offsetLeft-c+"px",r.value=window.form.getAddressFromPinPosition(o)},d=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",d)}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card"),n=document.querySelector(".map__filters-container"),r=document.querySelector(".map__pins");let i,a;const c=(t,o,n,r)=>{switch(n){case o.offer.price:t.querySelector(r).textContent=n+" ₽/ночь";break;case o.offer.type:t.querySelector(r).textContent=e[n];break;case o.author.avatar:t.querySelector(r).src=n;break;default:t.querySelector(r).textContent=n}},d=(e,t,o,n)=>{t||Boolean(t.length)?n():e.querySelector(o).remove()},s=e=>{const r=document.createDocumentFragment();i=(e=>{const t=o.cloneNode(!0),n={advertDataField:[e.offer.title,e.offer.address,e.offer.price,e.offer.type,e.offer.description,e.author.avatar],fieldSelector:[".popup__title",".popup__text--address",".popup__text--price",".popup__type",".popup__description",".popup__avatar"]};for(let o=0;o<n.advertDataField.length;o++)d(t,n.advertDataField[o],n.fieldSelector[o],(()=>{c(t,e,n.advertDataField[o],n.fieldSelector[o])}));return d(t,e.offer.rooms||e.offer.guests,".popup__text--capacity",(()=>{e.offer.rooms&&e.offer.guests?t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`:e.offer.guests?e.offer.rooms||(t.querySelector(".popup__text--capacity").textContent=`для ${e.offer.guests} гостей`):t.querySelector(".popup__text--capacity").textContent=e.offer.rooms+" комнаты"})),d(t,e.offer.checkin||e.offer.checkout,".popup__text--time",(()=>{e.offer.checkin&&e.offer.checkout?t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`:e.offer.checkout?e.offer.checkin||(t.querySelector(".popup__text--time").textContent="Выезд до "+e.offer.checkout):t.querySelector(".popup__text--time").textContent="Заезд после "+e.offer.checkin})),d(t,e.offer.features,".popup__features",(()=>{const o=t.querySelector(".popup__features").children;for(let t=o.length-1;t>=0;t--)e.offer.features.includes(o[t].classList.toString().split("--")[1])||o[t].remove()})),d(t,e.offer.photos,".popup__photos",(()=>{const o=t.querySelector(".popup__photos"),n=o.querySelector(".popup__photo");e.offer.photos.forEach((e=>{o.appendChild(n.cloneNode()).src=e})),o.removeChild(n)})),t})(e),r.appendChild(i),a=i.querySelector(".popup__close"),t.insertBefore(r,n)},l=()=>{const e=r.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active"),i.remove()},u=e=>{"Escape"===e.key&&(e.preventDefault(),m())},p=e=>{r.querySelectorAll(".map__pin:not(.map__pin--main)").forEach(((t,o)=>{const n=e.target.parentNode===t||e.target===t;i&&n&&l(),n&&(0!==window.backend.filteredAdverts.length?s(window.backend.filteredAdverts.slice(0,window.filter.PINS_AMOUNT)[o]):s(window.backend.adverts.slice(0,window.filter.PINS_AMOUNT)[o]),document.addEventListener("keydown",u),a.addEventListener("click",m),t.classList.add("map__pin--active")),o++}))},m=()=>{i&&(l(),document.removeEventListener("keydown",u),a&&a.removeEventListener("click",m))};window.card={onClickOpenPopup:p,closePopup:m,onPinEnterPressOpenPopup:e=>{"Enter"===e.key&&p(e)}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=e.offsetWidth,o=e.offsetHeight,n=document.querySelector(".ad-form"),r=n.querySelector("input[name=address]"),i=document.querySelector(".map__filters"),a=document.querySelector("#success").content,c=(e,t)=>{const o=e.querySelectorAll("fieldset"),n=e.querySelectorAll("select");o.forEach((e=>{e.disabled=!t})),n.forEach((e=>{e.disabled=!t}))},d=()=>({x:e.style.left,y:e.style.top}),s=(e,o=t/2)=>{const n=d();return`${parseInt(parseInt(n.x,10)+o,10)},\n  ${parseInt(parseInt(n.y,10)+e,10)}`};let l;const u=()=>{l.remove(),document.removeEventListener("click",u)},p=e=>{"Escape"===e.key&&u(),document.removeEventListener("keydown",p)};c(n,!1),c(i,!1),r.value=s(o/2),window.form={changeAbility:c,getAddressFromPinPosition:s,getCoordsFromPinPosition:d,submit:e=>{l=(()=>{const e=a.querySelector(".success").cloneNode(!0);return document.createDocumentFragment().appendChild(e),document.querySelector("main").insertAdjacentElement("afterbegin",e)})(),e(),document.addEventListener("click",u),document.addEventListener("keydown",p)}}})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t=document.querySelector(".ad-form"),o=t.querySelector("input[name=title]"),n=t.querySelector("input[name=price]"),r=t.querySelector("select[name=type]"),i=t.querySelector("select[name=timein]"),a=t.querySelector("select[name=timeout]"),c=t.querySelector("select[name=rooms]"),d=t.querySelector("select[name=capacity]");window.validation={onChangeMatchPriceToType:()=>{n.min=n.placeholder=e[r.value]},onChangeMatchTimesOut:()=>{i.value=a.value},onChangeMatchTimesIn:()=>{a.value=i.value},onInputCheckTitle:()=>{o.value.length<o.minLength?o.setCustomValidity(`Заголовок должен состоять минимум из ${o.minLength} символов`):o.value.length>o.maxLength?o.setCustomValidity(`Заголовок не должен превышать ${o.maxLength} символов`):o.setCustomValidity(""),o.reportValidity()},onInputCheckPrice:()=>{+n.value<n.min?n.setCustomValidity("Цена слишком маленькая"):+n.value>n.max?n.setCustomValidity("Цена слишком большая"):n.setCustomValidity(""),n.reportValidity()},onInputMatchRoomsToCapacity:()=>{0==+d.value&&100!=+c.value?(c.setCustomValidity("Нужно 100 комнат"),d.setCustomValidity("")):0!=+d.value&&100==+c.value?(c.setCustomValidity(""),d.setCustomValidity("Не для гостей")):+d.value>c.value?(c.setCustomValidity("Нужно больше комнат"),d.setCustomValidity("")):(c.setCustomValidity(""),d.setCustomValidity("")),c.reportValidity(),d.reportValidity()}}})(),(()=>{const e="any",t=document.querySelector(".map__pins"),o=document.querySelector(".map__filters"),n=o.querySelector("select[name=housing-type]"),r=o.querySelector("select[name=housing-price]"),i=o.querySelector("select[name=housing-rooms]"),a=o.querySelector("select[name=housing-guests]"),c=o.querySelector(".map__features"),d=window.debounce((()=>{window.card.closePopup(),t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}));const o=c.querySelectorAll(".map__checkbox:checked"),d=[],s=e=>{for(let t of o)if(!e.offer.features.includes(t.value))return!1;return!0};for(let t=0;t<window.backend.adverts.length;t++){const o=window.backend.adverts[t];if(o.offer.type!==n.value&&n.value!==e||r.value!==e&&((l=o.offer.price)<1e4?"low":l>=1e4&&l<5e4?"middle":"high")!==r.value||i.value!==e&&o.offer.rooms!==+i.value||a.value!==e&&o.offer.guests!==+a.value||!s(o)||d.push(o),d.length>=5)break}var l;window.backend.filteredAdverts=d,window.renderPinsArray(window.backend.filteredAdverts)}));window.filter={onChange:d,PINS_AMOUNT:5}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=o.src,r=document.querySelector(".ad-form__upload input[type=file]"),i=document.querySelector(".ad-form__photo"),a=e=>{o.src=e.result},c=e=>{const t=document.createElement("img");t.src=e.result,t.style.width="100%",t.style.height="100%",i.append(t)},d=(t,o)=>{const n=t.files[0],r=n.type;if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o(e)})),e.readAsDataURL(n)}};window.upload={onAvatarChange:()=>{d(t,a)},onHousingPicturesChange:()=>{d(r,c)},clearAvatarPreview:()=>{o.src=n},clearHousingPictures:()=>{for(;i.firstChild;)i.removeChild(i.firstChild)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=document.querySelector(".map__pin--main"),n=o.offsetHeight,r=document.querySelector(".map__filters"),i=document.querySelector(".ad-form"),a=i.querySelector(".ad-form__reset"),c=i.querySelector("input[name=address]"),d=i.querySelector("input[name=title]"),s=i.querySelector("input[name=price]"),l=i.querySelector("select[name=type]"),u=i.querySelector("select[name=timein]"),p=i.querySelector("select[name=timeout]"),m=i.querySelector("select[name=rooms]"),f=i.querySelector("select[name=capacity]"),v=document.querySelector(".ad-form__field input[type=file]"),w=document.querySelector(".ad-form__upload input[type=file]"),y=window.form.getCoordsFromPinPosition(),h=()=>{window.backend.load(g,window.backend.onLoadError)},_=e=>{"Enter"===e.key&&(0!==window.backend.adverts.length?g():h())},g=y=>{0===window.backend.adverts.length&&(window.backend.adverts=y.filter((e=>void 0!==e.offer))),e.classList.remove("map--faded"),i.classList.remove("ad-form--disabled"),window.form.changeAbility(i,!0),window.form.changeAbility(r,!0),c.value=window.form.getAddressFromPinPosition(n+26),t.querySelector(".map__pin:not(.map__pin--main)")||window.renderPinsArray(window.backend.adverts.slice(0,window.filter.PINS_AMOUNT)),l.addEventListener("change",window.validation.onChangeMatchPriceToType),u.addEventListener("change",window.validation.onChangeMatchTimesIn),p.addEventListener("change",window.validation.onChangeMatchTimesOut),d.addEventListener("input",window.validation.onInputCheckTitle),s.addEventListener("input",window.validation.onInputCheckPrice),m.addEventListener("input",window.validation.onInputMatchRoomsToCapacity),f.addEventListener("input",window.validation.onInputMatchRoomsToCapacity),e.addEventListener("click",window.card.onClickOpenPopup),e.addEventListener("keydown",window.card.onPinEnterPressOpenPopup),o.removeEventListener("mousedown",h),o.removeEventListener("mousedown",g),o.removeEventListener("keydown",_),i.addEventListener("submit",E),a.addEventListener("click",S),r.addEventListener("change",window.filter.onChange),v.addEventListener("change",window.upload.onAvatarChange),w.addEventListener("change",window.upload.onHousingPicturesChange)},S=()=>{e.classList.add("map--faded"),i.reset(),r.reset(),window.form.changeAbility(i,!1),window.form.changeAbility(r,!1),i.classList.add("ad-form--disabled"),o.style.left=y.x,o.style.top=y.y,c.value=window.form.getAddressFromPinPosition(n/2),t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()})),l.removeEventListener("change",window.validation.onChangeMatchPriceToType),u.removeEventListener("change",window.validation.onChangeMatchTimesIn),p.removeEventListener("change",window.validation.onChangeMatchTimesOut),d.removeEventListener("input",window.validation.onInputCheckTitle),s.removeEventListener("input",window.validation.onInputCheckPrice),m.removeEventListener("input",window.validation.onInputMatchRoomsToCapacity),f.removeEventListener("input",window.validation.onInputMatchRoomsToCapacity),e.removeEventListener("click",window.card.onClickOpenPopup),e.removeEventListener("keydown",window.card.onPinEnterPressOpenPopup),i.removeEventListener("submit",E),r.removeEventListener("change",window.filter.onChange),v.removeEventListener("change",window.upload.onAvatarChange),w.removeEventListener("change",window.upload.onHousingPicturesChange),window.upload.clearAvatarPreview(),window.upload.clearHousingPictures(),k(),window.card.closePopup(),window.backend.filteredAdverts=[]},q=()=>{window.form.submit(S)},E=e=>{e.preventDefault(),window.backend.save(new FormData(i),q,window.backend.onSubmitError)},k=()=>{o.addEventListener("mousedown",window.onMovePin),0===window.backend.adverts.length?o.addEventListener("mousedown",h):o.addEventListener("mousedown",g),o.addEventListener("keydown",_)};k()})()})();