(()=>{"use strict";(()=>{const e=document.querySelector("#error").content,t=document.querySelector(".ad-form");let n=function(n,o){const r=document.createDocumentFragment();let i=function(t){const n=e.querySelector(".error").cloneNode(!0);return n.querySelector(".error__message").textContent=t,n}(n);r.appendChild(i);const c=i.querySelector(".error__button");let a=function(){i.remove(),t.reset(),c.removeEventListener("click",a),document.removeEventListener("keydown",u),o&&document.removeEventListener("click",a)},u=function(e){"Escape"===e.key&&(e.preventDefault(),a())};c.addEventListener("click",a),document.addEventListener("keydown",u),o&&document.addEventListener("click",a),document.querySelector("main").insertAdjacentElement("afterbegin",i)},o=function(e,t,n){e.responseType="json",e.addEventListener("load",(function(){200===e.status?t(e.response):n(`Статус ответа: ${e.status} ${e.statusText}`)})),e.addEventListener("error",(function(){n("Произошла ошибка соединения")})),e.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4},r=function(e,t,n){const r=new XMLHttpRequest;o(r,t,n),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(e)};window.backend={load:function(e,t){const n=new XMLHttpRequest;o(n,e,t),n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:r,onLoadError:function(e){n(e)},onSubmitError:function(e){n(e,r)},announcements:[],filteredAnnouncements:[]}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),n=t.offsetWidth,o=t.offsetHeight;let r=function(e){const r=t.cloneNode(!0),i=r.querySelector("img");return r.style=`left: ${e.location.x-n/2}px; top: ${e.location.y-o}px`,i.src=e.author.avatar,i.alt=e.offer.title,r};window.renderPinsArray=function(t){const n=document.createDocumentFragment();for(let e=0;e<t.length;e++)n.appendChild(r(t[e]));e.appendChild(n)}})(),(()=>{const e=document.querySelector(".map").offsetWidth,t=document.querySelector(".map__pin--main"),n=t.offsetHeight+26,o=t.offsetWidth,r=document.querySelector(".ad-form").querySelector("input[name=address]");window.onMovePin=function(i){let c={x:i.clientX,y:i.clientY},a=function(i){const a=c.x-i.clientX,u=c.y-i.clientY;c={x:i.clientX,y:i.clientY},t.offsetTop<=130-n?t.style.top=130-n-u+"px":t.offsetTop>=630-n?t.style.top=630-n-u+"px":t.style.top=t.offsetTop-u+"px",t.offsetLeft<=-o/2?t.style.left=-o/2-a+"px":t.offsetLeft>=e-o/2?t.style.left=e-o/2-a+"px":t.style.left=t.offsetLeft-a+"px",r.value=window.form.getAddressFromPinPosition(n)},u=function(){document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",u)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",u)}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector(".map"),n=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container"),r=document.querySelector(".map__pins");let i,c,a=function(r){const a=document.createDocumentFragment();i=function(t){const o=n.cloneNode(!0);if(t.offer.title?o.querySelector(".popup__title").textContent=t.offer.title:o.querySelector(".popup__title"),t.offer.address?o.querySelector(".popup__text--address").textContent=t.offer.address:o.querySelector(".popup__text--address"),t.offer.price?o.querySelector(".popup__text--price").textContent=t.offer.price+" ₽/ночь":o.querySelector(".popup__text--price"),t.offer.type?o.querySelector(".popup__type").textContent=e[t.offer.type]:o.querySelector(".popup__type"),t.offer.rooms&&t.offer.guests?o.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`:t.offer.rooms?o.querySelector(".popup__text--capacity").textContent=t.offer.rooms+" комнаты":t.offer.guests?o.querySelector(".popup__text--capacity").textContent=`для ${t.offer.guests} гостей`:o.querySelector(".popup__text--capacity").remove(),t.offer.checkin&&t.offer.checkout?o.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`:t.offer.checkin?o.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin:t.offer.checkout?o.querySelector(".popup__text--time").textContent="Выезд до "+t.offer.checkout:o.querySelector(".popup__text--time").remove(),t.offer.description?o.querySelector(".popup__description").textContent=t.offer.description:o.querySelector(".popup__description").remove(),t.author.avatar?o.querySelector(".popup__avatar").src=t.author.avatar:o.querySelector(".popup__avatar").remove(),0!==t.offer.features.length){let e=o.querySelector(".popup__features").children;for(let n=e.length-1;n>=0;n--){let o=[];for(let r=t.offer.features.length-1;r>=0;r--)o[r]=e[n].classList.contains("popup__feature--"+t.offer.features[r]);o.includes(!0)||e[n].remove()}}else o.querySelector(".popup__features").remove();if(0!==t.offer.photos.length){const e=o.querySelector(".popup__photos"),n=e.querySelector(".popup__photo");for(let o=1;o<t.offer.photos.length;o++)e.appendChild(n.cloneNode());let r=e.children;for(let e=0;e<r.length;e++)r[e].src=t.offer.photos[e]}else o.querySelector(".popup__photos").remove();return o}(r),a.appendChild(i),c=i.querySelector(".popup__close"),t.insertBefore(a,o)},u=function(){const e=r.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active"),i.remove()},s=function(e){"Escape"===e.key&&(e.preventDefault(),l())},d=function(e){const t=r.querySelectorAll(".map__pin:not(.map__pin--main)");for(let n=0;n<t.length;n++){const o=e.target.parentNode===t[n]||e.target===t[n];i&&o&&u(),o&&(0!==window.backend.filteredAnnouncements.length?a(window.backend.filteredAnnouncements.slice(0,window.filter.PINS_AMOUNT)[n]):a(window.backend.announcements.slice(0,window.filter.PINS_AMOUNT)[n]),document.addEventListener("keydown",s),c.addEventListener("click",l),t[n].classList.add("map__pin--active"))}},l=function(){i&&(u(),document.removeEventListener("keydown",s),c&&c.removeEventListener("click",l))};window.card={onClickOpenPopup:d,closePopup:l,onPinEnterPressOpenPopup:function(e){"Enter"===e.key&&d(e)}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=e.offsetWidth,n=e.offsetHeight,o=document.querySelector(".ad-form"),r=o.querySelector("input[name=address]"),i=document.querySelector(".map__filters"),c=document.querySelector("#success").content;let a,u=function(e,t){const n=e.querySelectorAll("fieldset"),o=e.querySelectorAll("select");n.forEach((function(e){e.disabled=!t})),o.forEach((function(e){e.disabled=!t}))},s=function(){return{x:e.style.left,y:e.style.top}},d=function(e,n=t/2){const o=s();return`${parseInt(parseInt(o.x,10)+n,10)}, ${parseInt(parseInt(o.y,10)+e,10)}`},l=function(){a.remove(),document.removeEventListener("click",l)},p=function(e){"Escape"===e.key&&l(),document.removeEventListener("keydown",p)};u(o,!1),u(i,!1),r.value=d(n/2),window.form={changeAbility:u,getAddressFromPinPosition:d,getCoordsFromPinPosition:s,submit:function(e){a=function(){const e=c.querySelector(".success").cloneNode(!0);return document.createDocumentFragment().appendChild(e),document.querySelector("main").insertAdjacentElement("afterbegin",e)}(),e(),document.addEventListener("click",l),document.addEventListener("keydown",p)}}})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t=document.querySelector(".ad-form"),n=t.querySelector("input[name=title]"),o=t.querySelector("input[name=price]"),r=t.querySelector("select[name=type]"),i=t.querySelector("select[name=timein]"),c=t.querySelector("select[name=timeout]"),a=t.querySelector("select[name=rooms]"),u=t.querySelector("select[name=capacity]");window.validation={onChangeMatchPriceToType:function(){o.min=o.placeholder=e[r.value]},onChangeMatchTimesOut:function(){i.value=c.value},onChangeMatchTimesIn:function(){c.value=i.value},onInputCheckTitle:function(){n.value.length<n.minLength?n.setCustomValidity(`Заголовок должен состоять минимум из ${n.minLength} символов`):n.value.length>n.maxLength?n.setCustomValidity(`Заголовок не должен превышать ${n.maxLength} символов`):n.setCustomValidity(""),n.reportValidity()},onInputCheckPrice:function(){+o.value<o.min?o.setCustomValidity("Цена слишком маленькая"):+o.value>o.max?o.setCustomValidity("Цена слишком большая"):o.setCustomValidity(""),o.reportValidity()},onInputMatchRoomsToCapacity:function(){0==+u.value&&100!=+a.value?(a.setCustomValidity("Нужно 100 комнат"),u.setCustomValidity("")):0!=+u.value&&100==+a.value?(a.setCustomValidity(""),u.setCustomValidity("Не для гостей")):+u.value>a.value?(a.setCustomValidity("Нужно больше комнат"),u.setCustomValidity("")):(a.setCustomValidity(""),u.setCustomValidity("")),a.reportValidity(),u.reportValidity()}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map__filters"),n=t.querySelector("select[name=housing-type]"),o=t.querySelector("select[name=housing-price]"),r=t.querySelector("select[name=housing-rooms]"),i=t.querySelector("select[name=housing-guests]"),c=t.querySelector(".map__features");let a=window.debounce((function(){window.card.closePopup(),e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}));const t=c.querySelectorAll(".map__checkbox:checked");let a=[],u=function(e){for(let n of t)if(!e.offer.features.includes(n.value))return!1;return!0};for(let e=0;e<window.backend.announcements.length;e++){let t=window.backend.announcements[e];if(t.offer.type!==n.value&&"any"!==n.value||"any"!==o.value&&((s=t.offer.price)<1e4?"low":s>=1e4&&s<5e4?"middle":"high")!==o.value||"any"!==r.value&&t.offer.rooms!==+r.value||"any"!==i.value&&t.offer.guests!==+i.value||!u(t)||a.push(t),a.length>=5)break}var s;window.backend.filteredAnnouncements=a,window.renderPinsArray(window.backend.filteredAnnouncements)}));window.filter={onChange:a,PINS_AMOUNT:5}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),n=document.querySelector(".map__pin--main"),o=n.offsetHeight,r=document.querySelector(".map__filters"),i=document.querySelector(".ad-form"),c=i.querySelector(".ad-form__reset"),a=i.querySelector("input[name=address]"),u=i.querySelector("input[name=title]"),s=i.querySelector("input[name=price]"),d=i.querySelector("select[name=type]"),l=i.querySelector("select[name=timein]"),p=i.querySelector("select[name=timeout]"),m=i.querySelector("select[name=rooms]"),f=i.querySelector("select[name=capacity]"),y=window.form.getCoordsFromPinPosition();let v=function(){window.backend.load(h,window.backend.onLoadError)},w=function(e){"Enter"===e.key&&(0===window.backend.announcements.length?v():h())},h=function(y){0===window.backend.announcements.length&&(window.backend.announcements=y.filter((function(e){return void 0!==e.offer}))),e.classList.remove("map--faded"),i.classList.remove("ad-form--disabled"),window.form.changeAbility(i,!0),window.form.changeAbility(r,!0),a.value=window.form.getAddressFromPinPosition(o+26),t.querySelector(".map__pin:not(.map__pin--main)")||window.renderPinsArray(window.backend.announcements.slice(0,window.filter.PINS_AMOUNT)),d.addEventListener("change",window.validation.onChangeMatchPriceToType),l.addEventListener("change",window.validation.onChangeMatchTimesIn),p.addEventListener("change",window.validation.onChangeMatchTimesOut),u.addEventListener("input",window.validation.onInputCheckTitle),s.addEventListener("input",window.validation.onInputCheckPrice),m.addEventListener("input",window.validation.onInputMatchRoomsToCapacity),f.addEventListener("input",window.validation.onInputMatchRoomsToCapacity),e.addEventListener("click",window.card.onClickOpenPopup),e.addEventListener("keydown",window.card.onPinEnterPressOpenPopup),n.removeEventListener("mousedown",v),n.removeEventListener("mousedown",h),n.removeEventListener("keydown",w),i.addEventListener("submit",q),c.addEventListener("click",_),r.addEventListener("change",window.filter.onChange)},_=function(){e.classList.add("map--faded"),i.reset(),r.reset(),window.form.changeAbility(i,!1),window.form.changeAbility(r,!1),i.classList.add("ad-form--disabled"),n.style.left=y.x,n.style.top=y.y,a.value=window.form.getAddressFromPinPosition(o/2),t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()})),d.removeEventListener("change",window.validation.onChangeMatchPriceToType),l.removeEventListener("change",window.validation.onChangeMatchTimesIn),p.removeEventListener("change",window.validation.onChangeMatchTimesOut),u.removeEventListener("input",window.validation.onInputCheckTitle),s.removeEventListener("input",window.validation.onInputCheckPrice),m.removeEventListener("input",window.validation.onInputMatchRoomsToCapacity),f.removeEventListener("input",window.validation.onInputMatchRoomsToCapacity),e.removeEventListener("click",window.card.onClickOpenPopup),e.removeEventListener("keydown",window.card.onPinEnterPressOpenPopup),i.removeEventListener("submit",q),r.removeEventListener("change",window.filter.onChange),g(),window.card.closePopup()},S=function(){window.form.submit(_)},q=function(e){e.preventDefault(),window.backend.save(new FormData(i),S,window.backend.onSubmitError)},g=function(){n.addEventListener("mousedown",window.onMovePin),0===window.backend.announcements.length?n.addEventListener("mousedown",v):n.addEventListener("mousedown",h),n.addEventListener("keydown",w)};g()})()})();